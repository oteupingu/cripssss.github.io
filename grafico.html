<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros e Gráfico de Totais Reais</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f2f2f2;
        }
        .table-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            max-height: 500px;
            overflow-y: auto;
            width: 100%;
            max-width: 1000px;
            margin: 10px 0;
        }
        canvas {
            max-width: 600px;
            width: 100%;
            margin-top: 20px;
        }
        h2, h3 {
            text-align: center;
            color: #333;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: 700;
        }
        tfoot td {
            font-weight: bold;
            background-color: #eee;
        }
    </style>
</head>
<body>
    <h1>Registros e Gráfico de Totais Reais</h1>
    
    <div class="table-container">
        <h2>Registro - Planilha 1 (compras)</h2>
        <table id="tabelaRegistos1">
            <thead>
                <tr>
                    <th>Comprador</th>
                    <th>Classe 0</th>
                    <th>Classe 1</th>
                    <th>Classe 2</th>
                    <th>Classe 3</th>
                    <th>Munição Pistola</th>
                    <th>Munição SMG</th>
                    <th>Munição Fuzil</th>
                    <th>Nitro</th>
                    <th>Ticket Corrida</th>
                    <th>Pé de Cabra</th>
                    <th>Rastreador</th>
                    <th>Lockpick</th>
                    <th>Drogas</th>
                    <th>LSD</th>
                    <th>Máscara Gás</th>
                    <th>Pendrive</th>
                    <th>Parceria</th>
                    <th>Total (€)</th>
                </tr>
            </thead>
            <tbody id="data1"></tbody>
            <tfoot>
                <tr>
                    <td colspan="18">Total Geral</td>
                    <td id="totalGeral1">€0</td>
                </tr>
            </tfoot>
        </table>
        <a href="org.html" class="botao">vendas</a>
        <a href="compras.html" class="botao">compras</a>
    </div>
    
    <div class="table-container">
        <h2>Registro - Planilha 2 (vendas)</h2>
        <table id="tabelaRegistos2">
            <thead>
                <tr>
                    <th>Comprador</th>
                    <th>Parceria</th>
                    <th>Algemas</th>
                    <th>Cordas</th>
                    <th>C4</th>
                    <th>Capuz</th>
                    <th>Keycard</th>
                    <th>Lavagem</th>
                    <th>Total (€)</th>
                </tr>
            </thead>
            <tbody id="data2"></tbody>
            <tfoot>
                <tr>
                    <td colspan="8">Total Geral</td>
                    <td id="totalGeral2">€0</td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <canvas id="totalsChart"></canvas>

    <script>
        // URLs dos Google Apps Scripts
        const scriptUrl1 = 'https://script.google.com/macros/s/AKfycbzU0q4tIwEzYoYdTb3M9DH34ICRnOr3_oSRK5rsMUvEcSdLX6-U04I-IeFHmBm-AES-/exec?action=get';
        const scriptUrl2 = 'https://script.google.com/macros/s/AKfycbwbe5TUpZLnh1QcSG33H9MIcYIpTJv5jAG4vnSRLdVTAewbNFxrEw0_8Nd7ei9hiYI9/exec?action=get';

        // Função para carregar e exibir dados de uma planilha
        async function fetchAndDisplayData(url, tableBodyId, totalId, fields) {
            try {
                // Validação inicial dos parâmetros
                if (!url || !tableBodyId || !totalId || !Array.isArray(fields) || fields.length === 0) {
                    throw new Error('Parâmetros inválidos fornecidos');
                }

                // Busca dos dados
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Erro HTTP! Status: ${response.status}`);
                }

                const data = await response.json();
                console.debug(`Dados brutos de ${url}:`, JSON.stringify(data, null, 2));

                const tableBody = document.getElementById(tableBodyId);
                if (!tableBody) {
                    throw new Error(`Elemento com ID ${tableBodyId} não encontrado`);
                }

                const totalElement = document.getElementById(totalId);
                if (!totalElement) {
                    throw new Error(`Elemento com ID ${totalId} não encontrado`);
                }

                let total = 0;

                // Limpa o conteúdo anterior da tabela
                tableBody.innerHTML = '';

                if (data?.compras && Array.isArray(data.compras) && data.compras.length > 0) {
                    data.compras.forEach(reg => {
                        const row = tableBody.insertRow();
                        fields.forEach(field => {
                            const cell = row.insertCell();
                            if (field === 'total') {
                                // Normaliza o valor do campo total
                                let rawValue = reg[field]?.toString() || '0';
                                rawValue = rawValue
                                    .replace(/[^\d,.]/g, '') // Remove caracteres não numéricos, exceto ponto e vírgula
                                    .replace(',', '.'); // Converte vírgula para ponto
                                const numericValue = parseFloat(rawValue);

                                if (!isNaN(numericValue)) {
                                    total += numericValue;
                                    cell.textContent = `€${numericValue.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                                } else {
                                    console.warn(`Valor inválido para total: ${reg[field]}`);
                                    cell.textContent = '€0,00';
                                }
                            } else {
                                // Tratamento de outros campos
                                let value = reg[field];
                                if (value === undefined || value === null) {
                                    value = {
                                        'comprador': 'Sem nome',
                                        'Parceria': 'Sem parceria'
                                    }[field] || '0';
                                }
                                cell.textContent = value;
                            }
                        });
                    });
                    totalElement.textContent = `€${total.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else {
                    tableBody.innerHTML = `<tr><td colspan="${fields.length}">Nenhum dado encontrado.</td></tr>`;
                    totalElement.textContent = '€0,00';
                }

                return total;
            } catch (error) {
                console.error(`Erro ao carregar ${url}:`, error);
                const tableBody = document.getElementById(tableBodyId);
                const totalElement = document.getElementById(totalId);
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="${fields.length}">Erro ao carregar dados.</td></tr>`;
                }
                if (totalElement) {
                    totalElement.textContent = 'Erro ao carregar';
                }
                return 0;
            }
        }

        // Função para criar o gráfico
        async function createChart() {
            const fields1 = ['comprador', 'Classe_0', 'Classe_1', 'Classe_2', 'Classe_3', 'Municao_Pistola', 'Municao_SMG', 'Municao_Fuzil', 'Nitro', 'Ticket_Corrida','Rastreador', 'Pe_Cabra', 'Lockpick', 'Drogas', 'LSD', 'Mascara_Gas', 'Pendrive', 'Parceria', 'total'];
            const fields2 = ['comprador', 'Parceria', 'Algemas', 'Cordas', 'C4', 'Capuz', 'Keycard', 'Lavagem', 'total'];

            const total1 = await fetchAndDisplayData(scriptUrl1, 'data1', 'totalGeral1', fields1);
            const total2 = await fetchAndDisplayData(scriptUrl2, 'data2', 'totalGeral2', fields2);
            console.log(`Total Planilha 1: €${total1.toFixed(2)}, Total Planilha 2: €${total2.toFixed(2)}`); // Log para depuração
            const combinedTotal = -total1 + total2;

            const ctx = document.getElementById('totalsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Planilha 1 (compras)', 'Planilha 2 (vendas)', 'Total Combinado'],
                    datasets: [{
                        label: 'Totais Reais (€)',
                        data: [total1, total2, combinedTotal],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(153, 102, 255, 0.5)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total (€)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `€${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Comparação de Totais Reais'
                        }
                    }
                }
            });
        }

        // Executa a função para carregar dados e criar o gráfico
        createChart();
    </script>
</body>
</html>